---
title: "trundler"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(trundler)
library(tidyverse)
set_api_key(Sys.getenv("TRUNDLER_KEY"))
```

## Overview

[Trundler](https://www.trundler.dev/#about) is a curated repository of historical pricing data from major retailers. Data from the Trundler [API](https://api.trundler.dev/) can be pulled into R easily with this package for use by suppliers who want to monitor mark-ups on their products, retailers who want to understand the pricing strategies of their competitors or regulators who want to monitor regulatory compliance. 


## Installation

Install from GitHub.

```{r install, eval=F}
remotes::install_github("datawookie/trundler")
```

<br>

## Usage 

```{r usage, eval=F}
library(trundler)

```

Check the package version:
```{r version, eval=T}
packageVersion("trundler")
```

<br>

## Set API Key 
To access the full API youâ€™ll first need to obtain a key from the [Trundler API](https://api.trundler.dev/).

To specify your API key for use in R:

```{r api, eval=F}
# Example API key (this key will not work)
set_api_key("5bed3ac9-6dc9-4926-aed8-8c97a7cb8057")
```

If you are subscribed via RapidAPI:

```{r rapidapi, eval=F}
set_rapidapi_key("5a1ae0ce24mshd483dae6ab7308dp129ef6jsn1f473053d6b0")
```

<br>

## Retailers()

Use `retailer()` to obtain a list of retailers: 

```{r retailer}
retailer()
```
You can also access the details of specific retailers:

```{r specific_retailer }
retailer(45)
```


<br>

## Products

Peruse the list of products for a specific retailer:

```{r retailer_products}
retailer_products(5)
```

Products can also be filtered by name and brand:

```{r rp_coffee}
retailer_products(5, product = "coffee", brand = "nespresso")
```

A similar search can be performed across *all* retailers:

```{r handsan}
products(product = "hand sanitiser")
```
One can also search using regular expressions:
```{r regexp}
products(product = "coffee", brand = "nespresso|nescafe")
```

For information on a specific product:
```{r prod}
item <- product(530290)
head(item)
```

Get the product name, [SKU](https://en.wikipedia.org/wiki/Stock_keeping_unit) and barcodes: 

```{r item_p}
item$product
```

```{r item_s}
item$sku
```

```{r item_b}
item$barcodes
```

## Prices

Get price history data for a specific product:
```{r p_hist}
product_prices(530290)
```


## Example: Surgical Mask Price Comparison

```{r get-data, cache=TRUE}
mask_products <- products(product="surgical( face)? masks") %>%
  inner_join(retailer(), by = "retailer_id") %>%
  filter(retailer %in% c("Dischem", "Clicks"))

mask_prices <- mask_products %>%
  mutate(
    price = map(product_id, product_prices)
  )
```

```{r wrangle}
mask_prices <- mask_prices %>%
  select(-product_id) %>%
  unnest(cols = c(price)) %>%
  mutate(
    date = as.Date(time)
  ) %>%
  select(retailer, product_id, date, price) %>%
  arrange(product_id, date) %>%
  group_by(product_id, retailer) %>%
  mutate(
    percentage = ((price - first(price)) / first(price)) * 100,
    step = price - lag(price),
    percentage = ifelse(step, percentage, NA)
  ) %>%
  ungroup() %>%
  select(-step)

